<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«‹å‡ç”³è«‹æˆåŠŸ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #fff;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .success-container {
            max-width: 600px;
            margin: 4rem auto;
            padding: 3rem;
            text-align: center;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }

        .success-icon {
            font-size: 4rem;
            color: #198754;
            margin-bottom: 1.5rem;
        }

        .success-message {
            font-size: 1.25rem;
            color: #495057;
            margin-bottom: 2.5rem;
        }

        .action-buttons .btn {
            margin: 0 0.5rem 1rem;
            padding: 0.75rem 1.5rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 0.125rem solid #dee2e6;
            border-top: 0.125rem solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: text-bottom;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .email-form {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 2rem 0;
            text-align: left;
        }
    </style>
</head>

<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <span class="navbar-brand">è«‹å‡ç”³è«‹ç³»çµ±</span>
            <div class="navbar-nav ms-auto">
                <span class="nav-text me-3" id="userWelcome">è¼‰å…¥ä¸­...</span>
                <button class="btn btn-outline-danger btn-sm" id="logoutBtn">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="success-container">
            <div class="success-icon">âœ…</div>
            <h3 class="mb-3">ç”³è«‹å·²æˆåŠŸæäº¤ï¼</h3>
            <p class="success-message">
                æ‚¨çš„è«‹å‡å–® .docx å·²ç”¢ç”Ÿä¸¦å„²å­˜è‡³è³‡æ–™åº«ã€‚
                <br><small class="text-muted" id="docxInfo">è³‡æ–™åº«è¨˜éŒ„ ID: è¼‰å…¥ä¸­...</small>
            </p>

            <!-- éƒµä»¶ç™¼é€è¡¨å–® -->
            <div class="email-form">
                <h5 class="mb-3">ğŸ“§ ç™¼é€éƒµä»¶é€šçŸ¥</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="recipientEmail" class="form-label">æ”¶ä»¶äºº Email</label>
                        <input type="email" class="form-control" id="recipientEmail" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººéƒµç®±">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="ccEmail" class="form-label">å‰¯æœ¬ (CC)</label>
                        <input type="email" class="form-control" id="ccEmail" placeholder="å¯é¸">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="emailSubject" class="form-label">éƒµä»¶ä¸»é¡Œ</label>
                    <input type="text" class="form-control" id="emailSubject" value="è«‹å‡ç”³è«‹å–®" placeholder="è«‹è¼¸å…¥éƒµä»¶ä¸»é¡Œ">
                </div>
                <div class="mb-3">
                    <label for="emailMessage" class="form-label">éƒµä»¶å…§å®¹</label>
                    <textarea class="form-control" id="emailMessage" rows="4" placeholder="è«‹è¼¸å…¥éƒµä»¶å…§å®¹ï¼ˆå¯é¸ï¼‰">æ‚¨å¥½ï¼Œ

è«‹åƒé–±é™„ä»¶ä¸­çš„è«‹å‡ç”³è«‹å–®ã€‚

è¬è¬ï¼</textarea>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="action-buttons">
                <button type="button" id="emailBtn" class="btn btn-primary">
                    <span id="emailBtnSpinner" class="loading-spinner" style="display: none;"></span>
                    <span id="emailBtnText">ğŸ“§ ç™¼é€éƒµä»¶ (å«é™„ä»¶)</span>
                </button>
                <button type="button" id="downloadBtn" class="btn btn-secondary">
                    ğŸ“¥ ä¸‹è¼‰ .docx
                </button>
            </div>
            <div class="mt-4">
                <a href="./01-leave-form.html" class="btn btn-link">ğŸ“ å»ºç«‹æ–°çš„ç”³è«‹</a>
                <a href="./00-login.html" class="btn btn-link">ğŸ  å›åˆ°é¦–é </a>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">æ“ä½œçµæœ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="resultModalBody">
                    <!-- Result content goes here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- è‡ªè¨‚ JavaScript -->
<script>
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const docxId = urlParams.get('id');
        let jwtToken = localStorage.getItem('jwtToken'); // ç¢ºä¿åœ¨å…¨å±€ä½œç”¨åŸŸ

        const resultModalEl = document.getElementById('resultModal');
        const resultModal = new bootstrap.Modal(resultModalEl);

        // æª¢æŸ¥å¿…è¦åƒæ•¸
        if (!docxId || !jwtToken) {
            $('.success-container').html("<h3 class='text-danger'>éŒ¯èª¤</h3><p>ç¼ºå°‘å¿…è¦çš„åƒæ•¸æˆ–ç™»å…¥ç‹€æ…‹ï¼Œè«‹è¿”å›è¡¨å–®é é¢é‡æ–°æäº¤ã€‚</p><a href='./01-leave-form.html' class='btn btn-primary'>è¿”å›</a>");
            return;
        }

        // è¼‰å…¥ç”¨æˆ¶è³‡è¨Š
        loadUserInfo();

        // ç™»å‡ºæŒ‰éˆ•
        $('#logoutBtn').on('click', function() {
            localStorage.removeItem('jwtToken');
            window.location.href = './00-login.html';
        });

        // é¡¯ç¤ºæ–‡æª” ID
        $('#docxInfo').text(`è³‡æ–™åº«è¨˜éŒ„ ID: ${docxId}`);

        // ç™¼é€éƒµä»¶æŒ‰éˆ•é»æ“Šäº‹ä»¶
        $('#emailBtn').on('click', function () {
            const recipientEmail = $('#recipientEmail').val().trim();
            const subject = $('#emailSubject').val().trim();
            const message = $('#emailMessage').val().trim();
            
            if (!recipientEmail) {
                showResult('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥æ”¶ä»¶äºº Email åœ°å€');
                return;
            }
            
            if (!subject) {
                showResult('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥éƒµä»¶ä¸»é¡Œ');
                return;
            }

            $(this).prop('disabled', true);
            $('#emailBtnText').text('ç™¼é€ä¸­...');
            $('#emailBtnSpinner').show();

            const emailData = {
                docxId: docxId,
                recipient: recipientEmail,
                cc: $('#ccEmail').val().trim() || null,
                subject: subject,
                message: message
            };

            $.ajax({
                url: 'http://localhost:3000/email/send-with-attachment',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(emailData),
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                success: function (response) {
                    if (response.success) {
                        showResult('ç™¼é€æˆåŠŸ', 'âœ… ' + response.message);
                    } else {
                        showResult('ç™¼é€å¤±æ•—', 'âŒ ' + response.message);
                    }
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        handleAuthError();
                        return;
                    }
                    const errorResponse = xhr.responseJSON || { message: 'ç„¡æ³•é€£æ¥ä¼ºæœå™¨ã€‚' };
                    showResult('è«‹æ±‚éŒ¯èª¤', 'âŒ ' + errorResponse.message);
                },
                complete: function () {
                    $('#emailBtn').prop('disabled', false);
                    $('#emailBtnText').text('ğŸ“§ ç™¼é€éƒµä»¶ (å«é™„ä»¶)');
                    $('#emailBtnSpinner').hide();
                }
            });
        });

        // ä¸‹è¼‰æŒ‰éˆ•é»æ“Šäº‹ä»¶ - ä¿®å¾©ç‰ˆæœ¬
        $('#downloadBtn').on('click', function() {
            const $btn = $(this);
            const originalText = $btn.text();
            
            $btn.prop('disabled', true).text('ä¸‹è¼‰ä¸­...');
            
            const downloadUrl = `http://localhost:3000/api/docx-download/${docxId}`;
            
            console.log('é–‹å§‹ä¸‹è¼‰ï¼ŒURL:', downloadUrl);
            console.log('ä½¿ç”¨ Token:', jwtToken ? 'Token å­˜åœ¨' : 'Token ä¸å­˜åœ¨');
            
            fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Accept': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                }
            })
            .then(response => {
                console.log('ä¸‹è¼‰éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                console.log('éŸ¿æ‡‰æ¨™é ­:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP ${response.status}`);
                    }).catch(() => {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                
                return response.blob();
            })
            .then(blob => {
                console.log('ä¸‹è¼‰ Blob å¤§å°:', blob.size, 'bytes');
                console.log('Blob é¡å‹:', blob.type);
                
                if (blob.size === 0) {
                    throw new Error('ä¸‹è¼‰çš„æª”æ¡ˆç‚ºç©º');
                }
                
                // å‰µå»ºä¸‹è¼‰éˆæ¥
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `leave_application_${docxId}.docx`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // æ¸…ç† URL å°è±¡
                setTimeout(() => window.URL.revokeObjectURL(url), 1000);
                
                showResult('ä¸‹è¼‰æˆåŠŸ', 'âœ… æ–‡ä»¶å·²æˆåŠŸä¸‹è¼‰ï¼');
            })
            .catch(error => {
                console.error('ä¸‹è¼‰å¤±æ•—è©³ç´°éŒ¯èª¤:', error);
                showResult('ä¸‹è¼‰å¤±æ•—', `âŒ ${error.message}`);
            })
            .finally(() => {
                $btn.prop('disabled', false).text(originalText);
            });
        });

        // ä¿®å¾© loadUserInfo å‡½æ•¸
        function loadUserInfo() {
            console.log('è¼‰å…¥ç”¨æˆ¶è³‡è¨Šï¼ŒToken:', jwtToken ? 'Token å­˜åœ¨' : 'Token ä¸å­˜åœ¨');
            
            if (!jwtToken) {
                console.error('loadUserInfo: jwtToken æœªå®šç¾©');
                handleAuthError();
                return;
            }

            $.ajax({
                url: 'http://localhost:3000/auth/user/profile',
                type: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken
                },
                success: function(response) {
                    console.log('ç”¨æˆ¶è³‡è¨Šè¼‰å…¥æˆåŠŸ:', response);
                    if (response.success) {
                        $('#userWelcome').text(`æ­¡è¿ï¼Œ${response.user.name}`);
                        // è‡ªå‹•å¡«å…¥ç•¶å‰ç”¨æˆ¶çš„ email ä½œç‚ºé è¨­æ”¶ä»¶äºº
                        $('#recipientEmail').val(response.user.email);
                    } else {
                        console.error('ç”¨æˆ¶è³‡è¨Šè¼‰å…¥å¤±æ•—:', response);
                        handleAuthError();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('è¼‰å…¥ç”¨æˆ¶è³‡è¨Š AJAX éŒ¯èª¤:', { xhr, status, error });
                    handleAuthError();
                }
            });
        }

        function handleAuthError() {
            console.log('è™•ç†èªè­‰éŒ¯èª¤');
            localStorage.removeItem('jwtToken');
            alert('ç™»å…¥ç‹€æ…‹å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
            window.location.href = './00-login.html';
        }

        function showResult(title, message) {
            $('#resultModalLabel').text(title);
            $('#resultModalBody').html(message);
            resultModal.show();
        }
    });
</script>
</body>

</html>